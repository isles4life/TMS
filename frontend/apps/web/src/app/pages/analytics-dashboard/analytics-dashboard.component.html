<div class="analytics-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-title">
      <h1>Analytics & KPI Dashboard</h1>
      @if (useOfflineMode) {
        <span class="offline-badge">Offline Mode</span>
      }
    </div>
    <div class="header-actions">
      <form [formGroup]="dateForm" class="date-range-form">
        <mat-form-field appearance="outline">
          <mat-label>Start Date</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>End Date</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate">
          <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Grouping</mat-label>
          <mat-select formControlName="timeGrouping">
            <mat-option value="daily">Daily</mat-option>
            <mat-option value="weekly">Weekly</mat-option>
            <mat-option value="monthly">Monthly</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="refresh()">
          <mat-icon>refresh</mat-icon> Update
        </button>
        
        <button mat-stroked-button (click)="toggleOfflineMode()">
          <mat-icon>{{ useOfflineMode ? 'cloud' : 'cloud_off' }}</mat-icon>
          {{ useOfflineMode ? 'Go Online' : 'Use Mock Data' }}
        </button>

        <button mat-button [matMenuTriggerFor]="exportMenu" [disabled]="!dashboard">
          <mat-icon>download</mat-icon> Export
        </button>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item (click)="exportToPDF()">
            <mat-icon>picture_as_pdf</mat-icon>
            <span>Export to PDF</span>
          </button>
          <button mat-menu-item (click)="exportToExcel()">
            <mat-icon>table_chart</mat-icon>
            <span>Export to Excel</span>
          </button>
        </mat-menu>
      </form>
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (loading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!loading && metrics) {
    <!-- KPI Cards Grid -->
    <div class="kpi-grid">
      <!-- Delivery Performance -->
      <mat-card class="kpi-card delivery">
        <mat-card-header>
          <mat-icon>local_shipping</mat-icon>
          <mat-card-title>On-Time Delivery</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{metrics.onTimeDeliveryPercentage | number:'1.1-1'}}%</div>
          <div class="kpi-detail">
            <span class="success">{{metrics.onTimeDeliveries}} on-time</span>
            <span class="error">{{metrics.lateDeliveries}} late</span>
          </div>
          <div class="kpi-label">of {{metrics.totalDeliveries}} total deliveries</div>
        </mat-card-content>
      </mat-card>

      <!-- Driver Utilization -->
      <mat-card class="kpi-card driver">
        <mat-card-header>
          <mat-icon>person</mat-icon>
          <mat-card-title>Driver Utilization</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{metrics.driverUtilizationPercentage | number:'1.1-1'}}%</div>
          <div class="kpi-detail">
            <span>{{metrics.activeDrivers}} active</span>
            <span>{{metrics.availableDrivers}} available</span>
          </div>
          <div class="kpi-label">Avg {{metrics.averageHoursWorkedPerDriver | number:'1.1-1'}} hrs/driver</div>
        </mat-card-content>
      </mat-card>

      <!-- Equipment Utilization -->
      <mat-card class="kpi-card equipment">
        <mat-card-header>
          <mat-icon>directions_car</mat-icon>
          <mat-card-title>Equipment Utilization</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{metrics.equipmentUtilizationPercentage | number:'1.1-1'}}%</div>
          <div class="kpi-detail">
            <span>{{metrics.activeVehicles}} active</span>
            <span>{{metrics.availableVehicles}} available</span>
          </div>
          <div class="kpi-label">Fleet efficiency</div>
        </mat-card-content>
      </mat-card>

      <!-- Revenue -->
      <mat-card class="kpi-card revenue">
        <mat-card-header>
          <mat-icon>attach_money</mat-icon>
          <mat-card-title>Total Revenue</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">${{metrics.totalRevenue | number:'1.0-0'}}</div>
          <div class="kpi-detail">
            <span>${{metrics.revenuePerMile | number:'1.2-2'}}/mile</span>
          </div>
          <div class="kpi-label">Avg Load: ${{metrics.averageLoadRate | number:'1.0-0'}}</div>
        </mat-card-content>
      </mat-card>

      <!-- Loads -->
      <mat-card class="kpi-card loads">
        <mat-card-header>
          <mat-icon>inventory_2</mat-icon>
          <mat-card-title>Load Performance</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{metrics.totalLoads}}</div>
          <div class="kpi-detail">
            <span class="success">{{metrics.completedLoads}} completed</span>
            <span class="warning">{{metrics.inProgressLoads}} in-progress</span>
          </div>
          <div class="kpi-label">{{metrics.loadAcceptanceRate | number:'1.1-1'}}% acceptance rate</div>
        </mat-card-content>
      </mat-card>

      <!-- Miles -->
      <mat-card class="kpi-card miles">
        <mat-card-header>
          <mat-icon>route</mat-icon>
          <mat-card-title>Total Miles</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{metrics.totalMilesDriven | number:'1.0-0'}}</div>
          <div class="kpi-detail">
            <span>{{metrics.averageLoadedMilesPerVehicle | number:'1.0-0'}} loaded/vehicle</span>
          </div>
          <div class="kpi-label">Fleet mileage</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Top Drivers Table -->
    <mat-card class="data-card">
      <mat-card-header>
        <mat-icon>emoji_events</mat-icon>
        <mat-card-title>Top Performing Drivers</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="topDrivers" class="performance-table">
          <ng-container matColumnDef="driverName">
            <th mat-header-cell *matHeaderCellDef>Driver</th>
            <td mat-cell *matCellDef="let driver">{{driver.driverName}}</td>
          </ng-container>

          <ng-container matColumnDef="completedLoads">
            <th mat-header-cell *matHeaderCellDef>Loads</th>
            <td mat-cell *matCellDef="let driver">{{driver.completedLoads}}</td>
          </ng-container>

          <ng-container matColumnDef="onTimeDeliveryRate">
            <th mat-header-cell *matHeaderCellDef>On-Time %</th>
            <td mat-cell *matCellDef="let driver">{{driver.onTimeDeliveryRate | number:'1.1-1'}}%</td>
          </ng-container>

          <ng-container matColumnDef="revenue">
            <th mat-header-cell *matHeaderCellDef>Revenue</th>
            <td mat-cell *matCellDef="let driver">${{driver.revenue | number:'1.0-0'}}</td>
          </ng-container>

          <ng-container matColumnDef="overallScore">
            <th mat-header-cell *matHeaderCellDef>Score</th>
            <td mat-cell *matCellDef="let driver">
              <span class="score-badge" [class.high]="driver.overallScore >= 80">
                {{driver.overallScore | number:'1.0-0'}}
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="driverColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: driverColumns;"></tr>
        </table>

        @if (topDrivers.length === 0) {
          <div class="no-data">No driver data available for this period</div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Equipment Utilization Table -->
    <mat-card class="data-card">
      <mat-card-header>
        <mat-icon>build</mat-icon>
        <mat-card-title>Equipment Performance</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="equipmentStats" class="performance-table">
          <ng-container matColumnDef="equipmentNumber">
            <th mat-header-cell *matHeaderCellDef>Unit</th>
            <td mat-cell *matCellDef="let equip">{{equip.equipmentNumber}}</td>
          </ng-container>

          <ng-container matColumnDef="utilizationPercentage">
            <th mat-header-cell *matHeaderCellDef>Utilization</th>
            <td mat-cell *matCellDef="let equip">{{equip.utilizationPercentage | number:'1.1-1'}}%</td>
          </ng-container>

          <ng-container matColumnDef="tripsCompleted">
            <th mat-header-cell *matHeaderCellDef>Trips</th>
            <td mat-cell *matCellDef="let equip">{{equip.tripsCompleted}}</td>
          </ng-container>

          <ng-container matColumnDef="revenue">
            <th mat-header-cell *matHeaderCellDef>Revenue</th>
            <td mat-cell *matCellDef="let equip">${{equip.revenue | number:'1.0-0'}}</td>
          </ng-container>

          <ng-container matColumnDef="revenuePerMile">
            <th mat-header-cell *matHeaderCellDef>$/Mile</th>
            <td mat-cell *matCellDef="let equip">${{equip.revenuePerMile | number:'1.2-2'}}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="equipmentColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: equipmentColumns;"></tr>
        </table>

        @if (equipmentStats.length === 0) {
          <div class="no-data">No equipment data available for this period</div>
        }
      </mat-card-content>
    </mat-card>
  }

  <!-- No Data State -->
  @if (!loading && !metrics) {
    <mat-card class="no-data-card">
      <mat-card-content>
        <mat-icon>analytics</mat-icon>
        <h2>No Analytics Data</h2>
        <p>Select a date range and click Update to view analytics</p>
        <button mat-raised-button color="primary" (click)="refresh()">
          Load Dashboard
        </button>
      </mat-card-content>
    </mat-card>
  }
</div>
